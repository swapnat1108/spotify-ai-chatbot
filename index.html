<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spotify AI Music Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --spotify-green: #1DB954;
            --spotify-black: #191414;
            --spotify-white: #FFFFFF;
            --spotify-gray: #535353;
            --spotify-light-gray: #B3B3B3;
            --chat-bg: #121212;
            --message-user-bg: #333333;
            --message-bot-bg: #1DB954;
            --font-primary: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--spotify-black);
            color: var(--spotify-white);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overscroll-behavior: none;
        }

        .container {
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        .header {
            background-color: var(--spotify-black);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 32px;
            margin-right: 8px;
        }

        .logo h1 {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

        .user-profile img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .login-button {
            background-color: var(--spotify-green);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 8px 16px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-button:hover, .login-button:active {
            background-color: #1ed760;
            transform: scale(1.05);
        }

        /* Main Content Styles */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Chat Area Styles */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--chat-bg);
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            max-width: 85%;
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
            font-size: 0.95rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            background-color: var(--message-user-bg);
            color: var(--spotify-white);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message-bot {
            background-color: var(--message-bot-bg);
            color: var(--spotify-black);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
            text-align: right;
        }

        .bot-typing {
            align-self: flex-start;
            background-color: rgba(29, 185, 84, 0.3);
            border-radius: 18px;
            padding: 8px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
        }

        .typing-indicator span {
            height: 6px;
            width: 6px;
            background-color: var(--spotify-white);
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            opacity: 0.6;
        }

        .typing-indicator span:nth-child(1) {
            animation: bounce 1s infinite 0.2s;
        }

        .typing-indicator span:nth-child(2) {
            animation: bounce 1s infinite 0.4s;
        }

        .typing-indicator span:nth-child(3) {
            animation: bounce 1s infinite 0.6s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .chat-input {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: #282828;
            border-top: 1px solid #333;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .chat-input input {
            flex: 1;
            padding: 10px 14px;
            border: none;
            border-radius: 30px;
            background-color: #3E3E3E;
            color: var(--spotify-white);
            font-size: 0.95rem;
        }

        .chat-input input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--spotify-green);
        }

        .chat-input button {
            background-color: var(--spotify-green);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input button:hover, .chat-input button:active {
            background-color: #1ed760;
            transform: scale(1.05);
        }

        /* Player Styles */
        .player {
            background-color: #282828;
            padding: 12px;
            display: flex;
            align-items: center;
            border-top: 1px solid #333;
            position: sticky;
            bottom: 0;
            z-index: 9;
        }

        .now-playing {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0; /* Allow truncation */
        }

        .album-art {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            margin-right: 12px;
            background-color: #3E3E3E;
            overflow: hidden;
            flex-shrink: 0;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .track-info {
            flex: 1;
            min-width: 0; /* Allow truncation */
        }

        .track-name {
            font-weight: 700;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }

        .artist-name {
            font-size: 0.8rem;
            color: var(--spotify-light-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .control-button {
            background: none;
            border: none;
            color: var(--spotify-white);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px;
        }

        .control-button:hover, .control-button:active {
            color: var(--spotify-green);
            transform: scale(1.1);
        }

        .play-pause {
            background-color: var(--spotify-white);
            color: var(--spotify-black);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .play-pause:hover, .play-pause:active {
            transform: scale(1.1);
            background-color: var(--spotify-white);
            color: var(--spotify-black);
        }

        .volume-control {
            display: none; /* Hide on mobile */
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .welcome-logo {
            width: 100px;
            margin-bottom: 24px;
        }

        .welcome-title {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 16px;
        }

        .welcome-subtitle {
            font-size: 1rem;
            color: var(--spotify-light-gray);
            margin-bottom: 32px;
            max-width: 600px;
        }

        .welcome-features {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 32px;
            width: 100%;
            max-width: 320px;
        }

        .feature {
            background-color: #282828;
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }

        .feature-icon {
            font-size: 1.8rem;
            color: var(--spotify-green);
            margin-bottom: 12px;
        }

        .feature-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .feature-desc {
            font-size: 0.85rem;
            color: var(--spotify-light-gray);
        }

        /* Example Queries */
        .example-queries {
            margin-top: 16px;
            width: 100%;
            max-width: 320px;
        }

        .example-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
        }

        .example-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .example-query {
            background-color: #282828;
            border-radius: 30px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-size: 0.9rem;
        }

        .example-query:hover, .example-query:active {
            background-color: #3E3E3E;
            transform: translateY(-2px);
        }

        /* Playback SDK Status */
        .playback-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            font-size: 0.8rem;
            text-align: center;
            z-index: 100;
            display: none;
        }

        .playback-status.active {
            display: block;
        }

        .playback-status.success {
            background-color: rgba(29, 185, 84, 0.8);
        }

        .playback-status.error {
            background-color: rgba(255, 0, 0, 0.8);
        }

        /* Device Selector */
        .device-selector {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            background-color: #282828;
            padding: 16px;
            border-top: 1px solid #333;
            z-index: 20;
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .device-selector.active {
            display: flex;
        }

        .device-selector-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .device-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .device-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: #3E3E3E;
            border-radius: 8px;
            cursor: pointer;
        }

        .device-item.active {
            border: 1px solid var(--spotify-green);
        }

        .device-icon {
            margin-right: 8px;
            font-size: 1.1rem;
        }

        .device-name {
            font-size: 0.9rem;
        }

        .device-selector-close {
            align-self: center;
            margin-top: 8px;
            background-color: var(--spotify-gray);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 8px 16px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* Safari-specific fixes */
        @supports (-webkit-touch-callout: none) {
            .chat-messages {
                padding-bottom: 70px; /* Extra space for iOS Safari */
            }
            
            .chat-input {
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
            }
            
            .player {
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
            }
        }

        /* Media Queries */
        @media (min-width: 768px) {
            .welcome-features {
                flex-direction: row;
                max-width: 600px;
            }
            
            .feature {
                flex: 1;
            }
            
            .volume-control {
                display: flex;
                align-items: center;
                margin-left: 16px;
            }
            
            .volume-icon {
                color: var(--spotify-light-gray);
                margin-right: 8px;
            }
            
            .volume-slider {
                width: 80px;
                -webkit-appearance: none;
                height: 4px;
                border-radius: 2px;
                background: #5E5E5E;
                outline: none;
            }
            
            .volume-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--spotify-white);
                cursor: pointer;
            }
        }
    </style>
</head>
<body>
    <div class="playback-status" id="playback-status">
        Connecting to Spotify...
    </div>
    
    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="https://storage.googleapis.com/pr-newsroom-wp/1/2018/11/Spotify_Logo_RGB_Green.png" alt="Spotify Logo">
                <h1>AI Music Assistant</h1>
            </div>
            <div class="user-profile">
                <button id="login-button" class="login-button">
                    <i class="fab fa-spotify"></i> Login
                </button>
                <div id="user-info" style="display: none;">
                    <img id="user-avatar" src="" alt="User Avatar">
                    <span id="user-name"></span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Welcome Screen (shown before login) -->
            <div id="welcome-screen" class="welcome-screen">
                <img class="welcome-logo" src="https://storage.googleapis.com/pr-newsroom-wp/1/2018/11/Spotify_Logo_RGB_Green.png" alt="Spotify Logo">
                <h1 class="welcome-title">Spotify AI Music Assistant</h1>
                <p class="welcome-subtitle">Your personal AI-powered music companion. Just chat naturally to discover and play music.</p>
                
                <div class="welcome-features">
                    <div class="feature">
                        <div class="feature-icon">
                            <i class="fas fa-comment-alt"></i>
                        </div>
                        <h3 class="feature-title">Natural Conversation</h3>
                        <p class="feature-desc">Chat about your music preferences</p>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">
                            <i class="fas fa-music"></i>
                        </div>
                        <h3 class="feature-title">Smart Discovery</h3>
                        <p class="feature-desc">Find perfect music for any mood</p>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h3 class="feature-title">Learns Your Taste</h3>
                        <p class="feature-desc">Gets better over time</p>
                    </div>
                </div>
                
                <button id="welcome-login-button" class="login-button">
                    <i class="fab fa-spotify"></i> Get Started with Spotify
                </button>
                
                <div class="example-queries">
                    <h3 class="example-title">Try asking for:</h3>
                    <div class="example-list">
                        <div class="example-query">"Play some relaxing jazz for studying"</div>
                        <div class="example-query">"I want 90s Bollywood romantic songs"</div>
                        <div class="example-query">"Find me a playlist for deep focus"</div>
                        <div class="example-query">"Play something upbeat for working out"</div>
                    </div>
                </div>
            </div>

            <!-- Chat Interface (shown after login) -->
            <div id="chat-interface" class="chat-area" style="display: none;">
                <div class="chat-messages" id="chat-messages">
                    <div class="message message-bot">
                        Hi there! I'm your Spotify AI Music Assistant. What would you like to listen to today?
                        <div class="message-time">Just now</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="Ask me to play some music..." autocomplete="off">
                    <button id="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Player (shown after login) -->
        <div id="player" class="player" style="display: none;">
            <div class="now-playing">
                <div class="album-art">
                    <img id="album-image" src="https://i.scdn.co/image/ab67616d0000b273c5649add07ed3720be9d5526" alt="Album Art">
                </div>
                <div class="track-info">
                    <div id="track-name" class="track-name">Not Playing</div>
                    <div id="artist-name" class="artist-name">-</div>
                </div>
            </div>
            <div class="player-controls">
                <button class="control-button" id="prev-button">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-button play-pause" id="play-pause-button">
                    <i class="fas fa-play" id="play-icon"></i>
                </button>
                <button class="control-button" id="next-button">
                    <i class="fas fa-step-forward"></i>
                </button>
                <button class="control-button" id="device-button">
                    <i class="fas fa-mobile-alt"></i>
                </button>
            </div>
            <div class="volume-control">
                <div class="volume-icon">
                    <i class="fas fa-volume-up"></i>
                </div>
                <input type="range" min="0" max="100" value="50" class="volume-slider" id="volume-slider">
            </div>
        </div>
        
        <!-- Device Selector -->
        <div class="device-selector" id="device-selector">
            <div class="device-selector-title">Select Playback Device</div>
            <div class="device-list" id="device-list">
                <!-- Devices will be populated here -->
            </div>
            <button class="device-selector-close" id="device-selector-close">Close</button>
        </div>
    </div>

    <!-- Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    
    <script>
        // DOM Elements
        const loginButton = document.getElementById('login-button');
        const welcomeLoginButton = document.getElementById('welcome-login-button');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatInterface = document.getElementById('chat-interface');
        const player = document.getElementById('player');
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const exampleQueries = document.querySelectorAll('.example-query');
        const playbackStatus = document.getElementById('playback-status');
        const deviceSelector = document.getElementById('device-selector');
        const deviceList = document.getElementById('device-list');
        const deviceButton = document.getElementById('device-button');
        const deviceSelectorClose = document.getElementById('device-selector-close');
        
        // Spotify API Configuration
        const clientId = '54cc45b87374449585152aedac126fdf'; // User's Spotify Client ID
        const redirectUri = window.location.origin + window.location.pathname;
        const scopes = [
            'user-read-private',
            'user-read-email',
            'user-read-playback-state',
            'user-modify-playback-state',
            'user-read-currently-playing',
            'playlist-read-private',
            'playlist-read-collaborative',
            'user-library-read',
            'user-top-read',
            'user-read-recently-played',
            'streaming'
        ];

        // Global variables
        let accessToken = null;
        let player = null;
        let deviceId = null;
        let availableDevices = [];
        let currentTrack = null;
        let isPlaying = false;

        // Spotify Authentication
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        async function login() {
            const state = generateRandomString(16);
            const codeVerifier = generateRandomString(64);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // Store the code verifier in localStorage for later use
            localStorage.setItem('code_verifier', codeVerifier);
            
            // Construct the authorization URL
            const authUrl = new URL('https://accounts.spotify.com/authorize');
            const params = {
                client_id: clientId,
                response_type: 'code',
                redirect_uri: redirectUri,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge,
                state: state,
                scope: scopes.join(' ')
            };
            
            authUrl.search = new URLSearchParams(params).toString();
            window.location.href = authUrl.toString();
        }

        // Check if we're returning from Spotify auth
        async function checkAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                try {
                    // Exchange the code for an access token
                    const codeVerifier = localStorage.getItem('code_verifier');
                    
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            client_id: clientId,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: redirectUri,
                            code_verifier: codeVerifier
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('HTTP status ' + response.status);
                    }
                    
                    const data = await response.json();
                    accessToken = data.access_token;
                    
                    // Store tokens (in a real app, store these securely)
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);
                    localStorage.setItem('expires_at', Date.now() + (data.expires_in * 1000));
                    
                    // Initialize the player after successful authentication
                    initializePlayer();
                    
                    // Get user profile
                    await getUserProfile();
                    
                    // Show chat interface
                    showChatInterface();
                    
                    // Clean up the URL
                    window.history.replaceState({}, document.title, redirectUri);
                } catch (error) {
                    console.error('Error during authentication:', error);
                    showPlaybackStatus('Authentication failed. Please try again.', 'error');
                }
            } else {
                // Check if we have a stored token that's still valid
                const storedToken = localStorage.getItem('access_token');
                const expiresAt = localStorage.getItem('expires_at');
                
                if (storedToken && expiresAt && Date.now() < parseInt(expiresAt)) {
                    accessToken = storedToken;
                    
                    // Initialize the player with the stored token
                    initializePlayer();
                    
                    // Get user profile
                    await getUserProfile();
                    
                    // Show chat interface
                    showChatInterface();
                }
            }
        }

        async function refreshToken() {
            const refreshToken = localStorage.getItem('refresh_token');
            
            if (!refreshToken) {
                return false;
            }
            
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken,
                        client_id: clientId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('HTTP status ' + response.status);
                }
                
                const data = await response.json();
                accessToken = data.access_token;
                
                // Update stored tokens
                localStorage.setItem('access_token', data.access_token);
                if (data.refresh_token) {
                    localStorage.setItem('refresh_token', data.refresh_token);
                }
                localStorage.setItem('expires_at', Date.now() + (data.expires_in * 1000));
                
                return true;
            } catch (error) {
                console.error('Error refreshing token:', error);
                return false;
            }
        }

        async function getUserProfile() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expired, try to refresh
                        const refreshed = await refreshToken();
                        if (refreshed) {
                            return getUserProfile();
                        } else {
                            throw new Error('Token refresh failed');
                        }
                    }
                    throw new Error('HTTP status ' + response.status);
                }
                
                const profile = await response.json();
                
                // Update UI with user info
                loginButton.style.display = 'none';
                userInfo.style.display = 'flex';
                
                // Set user avatar if available
                if (profile.images && profile.images.length > 0) {
                    userAvatar.src = profile.images[0].url;
                } else {
                    userAvatar.src = 'https://via.placeholder.com/40?text=' + profile.display_name.charAt(0);
                }
                
                userName.textContent = profile.display_name;
                
                return profile;
            } catch (error) {
                console.error('Error fetching user profile:', error);
                return null;
            }
        }

        function showChatInterface() {
            welcomeScreen.style.display = 'none';
            chatInterface.style.display = 'flex';
            player.style.display = 'flex';
            
            // Add welcome message
            addBotMessage("I'm connected to your Spotify account! Try asking me to play some music, or ask for recommendations based on your mood.");
            
            // Scroll to bottom of chat
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Spotify Web Playback SDK
        function initializePlayer() {
            window.onSpotifyWebPlaybackSDKReady = () => {
                player = new Spotify.Player({
                    name: 'Spotify AI Music Assistant',
                    getOAuthToken: cb => { cb(accessToken); },
                    volume: 0.5
                });
                
                // Error handling
                player.addListener('initialization_error', ({ message }) => {
                    console.error('Initialization error:', message);
                    showPlaybackStatus('Player initialization failed: ' + message, 'error');
                });
                
                player.addListener('authentication_error', ({ message }) => {
                    console.error('Authentication error:', message);
                    showPlaybackStatus('Authentication error: ' + message, 'error');
                    
                    // Try to refresh the token
                    refreshToken().then(success => {
                        if (success) {
                            // Reinitialize player with new token
                            player.disconnect();
                            initializePlayer();
                        }
                    });
                });
                
                player.addListener('account_error', ({ message }) => {
                    console.error('Account error:', message);
                    showPlaybackStatus('Account error: ' + message, 'error');
                });
                
                player.addListener('playback_error', ({ message }) => {
                    console.error('Playback error:', message);
                    showPlaybackStatus('Playback error: ' + message, 'error');
                });
                
                // Ready
                player.addListener('ready', ({ device_id }) => {
                    console.log('Ready with Device ID', device_id);
                    deviceId = device_id;
                    showPlaybackStatus('Connected to Spotify', 'success');
                    
                    // Hide status after a delay
                    setTimeout(() => {
                        playbackStatus.classList.remove('active');
                    }, 3000);
                    
                    // Get available devices
                    getAvailableDevices();
                });
                
                // Not Ready
                player.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                    showPlaybackStatus('Disconnected from Spotify', 'error');
                });
                
                // Player State Changes
                player.addListener('player_state_changed', state => {
                    if (!state) {
                        return;
                    }
                    
                    currentTrack = state.track_window.current_track;
                    isPlaying = !state.paused;
                    
                    // Update player UI
                    updatePlayerUI(currentTrack, isPlaying);
                });
                
                // Connect to the player
                player.connect();
            };
        }

        function showPlaybackStatus(message, type = '') {
            playbackStatus.textContent = message;
            playbackStatus.className = 'playback-status active';
            
            if (type) {
                playbackStatus.classList.add(type);
            }
        }

        function updatePlayerUI(track, playing) {
            if (track) {
                document.getElementById('track-name').textContent = track.name;
                document.getElementById('artist-name').textContent = track.artists.map(artist => artist.name).join(', ');
                document.getElementById('album-image').src = track.album.images[0].url;
                
                // Update play/pause button
                const playIcon = document.getElementById('play-icon');
                if (playing) {
                    playIcon.className = 'fas fa-pause';
                } else {
                    playIcon.className = 'fas fa-play';
                }
            }
        }

        // Spotify API Calls
        async function makeApiRequest(endpoint, method = 'GET', body = null) {
            try {
                const headers = {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                };
                
                const options = {
                    method,
                    headers
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(`https://api.spotify.com/v1/${endpoint}`, options);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expired, try to refresh
                        const refreshed = await refreshToken();
                        if (refreshed) {
                            return makeApiRequest(endpoint, method, body);
                        } else {
                            throw new Error('Token refresh failed');
                        }
                    }
                    throw new Error(`HTTP status ${response.status}`);
                }
                
                // Some endpoints return no content
                if (response.status === 204) {
                    return {};
                }
                
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                showPlaybackStatus('API request failed: ' + error.message, 'error');
                throw error;
            }
        }

        async function searchTracks(query, limit = 10) {
            const endpoint = `search?q=${encodeURIComponent(query)}&type=track&limit=${limit}`;
            const data = await makeApiRequest(endpoint);
            return data.tracks.items;
        }

        async function playTrack(uri, deviceId = null) {
            const endpoint = 'me/player/play' + (deviceId ? `?device_id=${deviceId}` : '');
            const body = {
                uris: [uri]
            };
            
            return makeApiRequest(endpoint, 'PUT', body);
        }

        async function pausePlayback(deviceId = null) {
            const endpoint = 'me/player/pause' + (deviceId ? `?device_id=${deviceId}` : '');
            return makeApiRequest(endpoint, 'PUT');
        }

        async function resumePlayback(deviceId = null) {
            const endpoint = 'me/player/play' + (deviceId ? `?device_id=${deviceId}` : '');
            return makeApiRequest(endpoint, 'PUT');
        }

        async function skipToNext(deviceId = null) {
            const endpoint = 'me/player/next' + (deviceId ? `?device_id=${deviceId}` : '');
            return makeApiRequest(endpoint, 'POST');
        }

        async function skipToPrevious(deviceId = null) {
            const endpoint = 'me/player/previous' + (deviceId ? `?device_id=${deviceId}` : '');
            return makeApiRequest(endpoint, 'POST');
        }

        async function getAvailableDevices() {
            try {
                const data = await makeApiRequest('me/player/devices');
                availableDevices = data.devices;
                
                // Update device selector
                updateDeviceList();
                
                return availableDevices;
            } catch (error) {
                console.error('Error getting devices:', error);
                return [];
            }
        }

        function updateDeviceList() {
            // Clear current list
            deviceList.innerHTML = '';
            
            // Add each device
            availableDevices.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.className = 'device-item';
                if (device.id === deviceId) {
                    deviceItem.classList.add('active');
                }
                
                let iconClass = 'fas fa-laptop';
                if (device.type === 'Smartphone') {
                    iconClass = 'fas fa-mobile-alt';
                } else if (device.type === 'Speaker') {
                    iconClass = 'fas fa-volume-up';
                }
                
                deviceItem.innerHTML = `
                    <div class="device-icon"><i class="${iconClass}"></i></div>
                    <div class="device-name">${device.name}</div>
                `;
                
                deviceItem.addEventListener('click', () => {
                    transferPlayback(device.id);
                });
                
                deviceList.appendChild(deviceItem);
            });
        }

        async function transferPlayback(targetDeviceId) {
            try {
                await makeApiRequest('me/player', 'PUT', {
                    device_ids: [targetDeviceId],
                    play: isPlaying
                });
                
                // Update active device
                deviceId = targetDeviceId;
                
                // Update device list UI
                updateDeviceList();
                
                // Hide device selector
                deviceSelector.classList.remove('active');
                
                showPlaybackStatus('Playback transferred', 'success');
                
                // Hide status after a delay
                setTimeout(() => {
                    playbackStatus.classList.remove('active');
                }, 2000);
            } catch (error) {
                console.error('Error transferring playback:', error);
                showPlaybackStatus('Failed to transfer playback', 'error');
            }
        }

        // Chat Functionality
        function addUserMessage(text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'message-user');
            messageElement.textContent = text;
            
            const timeElement = document.createElement('div');
            timeElement.classList.add('message-time');
            timeElement.textContent = 'Just now';
            
            messageElement.appendChild(timeElement);
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addBotMessage(text) {
            // First show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('bot-typing');
            typingIndicator.innerHTML = `
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // After a short delay, remove typing indicator and add the actual message
            setTimeout(() => {
                chatMessages.removeChild(typingIndicator);
                
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', 'message-bot');
                messageElement.textContent = text;
                
                const timeElement = document.createElement('div');
                timeElement.classList.add('message-time');
                timeElement.textContent = 'Just now';
                
                messageElement.appendChild(timeElement);
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
        }

        async function handleUserMessage() {
            const message = messageInput.value.trim();
            if (message) {
                addUserMessage(message);
                messageInput.value = '';
                
                // Process the message
                await processUserMessage(message);
            }
        }

        async function processUserMessage(message) {
            try {
                // In a real implementation, this would call your NLU backend
                // For this demo, we'll use a simple keyword-based approach
                
                if (message.toLowerCase().includes('play') && message.toLowerCase().includes('jazz')) {
                    addBotMessage("Sure! Playing some relaxing jazz for you now.");
                    
                    const tracks = await searchTracks("relaxing jazz");
                    if (tracks && tracks.length > 0) {
                        await playTrack(tracks[0].uri, deviceId);
                    }
                } 
                else if (message.toLowerCase().includes('90s') && message.toLowerCase().includes('bollywood')) {
                    addBotMessage("Here's a mix of 90s Bollywood love songsâ€”enjoy!");
                    
                    const tracks = await searchTracks("90s bollywood romantic");
                    if (tracks && tracks.length > 0) {
                        await playTrack(tracks[0].uri, deviceId);
                    }
                }
                else if (message.toLowerCase().includes('focus') || message.toLowerCase().includes('study')) {
                    addBotMessage("I've found a great deep focus playlist to help you concentrate.");
                    
                    const tracks = await searchTracks("deep focus study");
                    if (tracks && tracks.length > 0) {
                        await playTrack(tracks[0].uri, deviceId);
                    }
                }
                else if (message.toLowerCase().includes('workout') || message.toLowerCase().includes('upbeat')) {
                    addBotMessage("Here's some energetic music to power your workout!");
                    
                    const tracks = await searchTracks("workout energetic");
                    if (tracks && tracks.length > 0) {
                        await playTrack(tracks[0].uri, deviceId);
                    }
                }
                else if (message.toLowerCase().includes('skip')) {
                    addBotMessage("Skipping to the next track.");
                    await skipToNext(deviceId);
                }
                else if (message.toLowerCase().includes('previous') || message.toLowerCase().includes('back')) {
                    addBotMessage("Going back to the previous track.");
                    await skipToPrevious(deviceId);
                }
                else if (message.toLowerCase().includes('pause') || message.toLowerCase().includes('stop')) {
                    addBotMessage("Pausing playback.");
                    await pausePlayback(deviceId);
                }
                else if (message.toLowerCase().includes('resume') || message.toLowerCase().includes('continue')) {
                    addBotMessage("Resuming playback.");
                    await resumePlayback(deviceId);
                }
                else {
                    // Generic search
                    addBotMessage(`Searching for "${message}" and playing the top result.`);
                    
                    const tracks = await searchTracks(message);
                    if (tracks && tracks.length > 0) {
                        await playTrack(tracks[0].uri, deviceId);
                    } else {
                        addBotMessage("I couldn't find any tracks matching your request. Please try a different search.");
                    }
                }
            } catch (error) {
                console.error('Error processing message:', error);
                addBotMessage("Sorry, I encountered an error while processing your request. Please try again.");
            }
        }

        // Event Listeners
        loginButton.addEventListener('click', login);
        welcomeLoginButton.addEventListener('click', login);
        
        sendButton.addEventListener('click', handleUserMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUserMessage();
            }
        });
        
        document.getElementById('play-pause-button').addEventListener('click', async () => {
            try {
                if (isPlaying) {
                    await pausePlayback(deviceId);
                } else {
                    await resumePlayback(deviceId);
                }
            } catch (error) {
                console.error('Error toggling playback:', error);
            }
        });
        
        document.getElementById('next-button').addEventListener('click', async () => {
            try {
                await skipToNext(deviceId);
                addBotMessage("Skipping to the next track.");
            } catch (error) {
                console.error('Error skipping to next:', error);
            }
        });
        
        document.getElementById('prev-button').addEventListener('click', async () => {
            try {
                await skipToPrevious(deviceId);
                addBotMessage("Going back to the previous track.");
            } catch (error) {
                console.error('Error skipping to previous:', error);
            }
        });
        
        document.getElementById('volume-slider')?.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            if (player) {
                player.setVolume(volume);
            }
        });
        
        // Device selector
        deviceButton.addEventListener('click', () => {
            getAvailableDevices().then(() => {
                deviceSelector.classList.toggle('active');
            });
        });
        
        deviceSelectorClose.addEventListener('click', () => {
            deviceSelector.classList.remove('active');
        });
        
        // Example query click handlers
        exampleQueries.forEach(query => {
            query.addEventListener('click', () => {
                // If already logged in, use the query
                if (chatInterface.style.display !== 'none') {
                    messageInput.value = query.textContent.replace(/"/g, '');
                    handleUserMessage();
                } else {
                    // Otherwise, prompt to login first
                    login();
                }
            });
        });

        // Check for authentication on page load
        window.addEventListener('load', () => {
            // Show connecting status
            showPlaybackStatus('Connecting to Spotify...', '');
            playbackStatus.classList.add('active');
            
            // Check authentication
            checkAuth();
        });
        // Spotify authentication configuration
const clientId = 54cc45b87374449585152aedac126fdf; // Replace with your Spotify Client ID
const redirectUri = 'https://swapnat1108.github.io/spotify-ai-chatbot/callback.html';

// Add event listeners to the login and get started buttons
document.querySelector('button:nth-of-type(1 )').addEventListener('click', authenticateWithSpotify);
document.querySelector('button:nth-of-type(2)').addEventListener('click', authenticateWithSpotify);

// Function to handle Spotify authentication
function authenticateWithSpotify() {
  const scopes = [
    'user-read-private',
    'user-read-email',
    'user-modify-playback-state',
    'user-read-playback-state',
    'streaming'
  ];
  
  // Redirect to Spotify authorization page
  window.location.href = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri )}&scope=${encodeURIComponent(scopes.join(' '))}`;
}
    </script>
</body>
</html>
